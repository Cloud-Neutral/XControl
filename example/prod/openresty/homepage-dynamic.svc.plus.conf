# ==============================================
# XControl Homepage — Production (Dynamic Render)
# Structure: Nginx → Node.js(3000) → Go(8080/8090)
# ==============================================

server {
  listen 80;
  server_name www.svc.plus global-homepage.svc.plus;
  return 301 https://$host$request_uri;
}

server {
  listen 443 ssl http2;
  server_name www.svc.plus global-homepage.svc.plus;

  ssl_certificate     /etc/ssl/svc.plus.pem;
  ssl_certificate_key /etc/ssl/svc.plus.rsa.key;
  ssl_protocols       TLSv1.2 TLSv1.3;
  ssl_ciphers         HIGH:!aNULL:!MD5;
  ssl_prefer_server_ciphers on;

  # ===============================
  # 基本安全头（推荐保持）
  # ===============================
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
  add_header X-Frame-Options "SAMEORIGIN";
  add_header X-Content-Type-Options "nosniff";
  add_header Referrer-Policy "strict-origin-when-cross-origin";
  add_header X-XSS-Protection "1; mode=block";

  # ===============================
  # API 反向代理
  # ===============================
  # 优先匹配认证服务
  location ^~ /api/auth/ {
    proxy_pass http://127.0.0.1:8080;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # 其他 /api/ 请求转 server 服务
  location ^~ /api/ {
    proxy_pass http://127.0.0.1:8090;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # AskAI 接口限流 (保持 Lua 逻辑不变)
  location = /api/askai {
    access_by_lua_block {
      local redis = require "resty.redis"
      local r = redis:new()
      r:set_timeout(200)
      local ok, err = r:connect("127.0.0.1", 6379)
      if not ok then
        ngx.log(ngx.ERR, "Redis connect error: ", err)
        return ngx.exit(500)
      end

      local user = ngx.var.arg_user or ngx.var.remote_addr
      local today = os.date("%Y%m%d")
      local key = "limit:user:" .. user .. ":" .. today

      local count, err = r:incr(key)
      if count == 1 then r:expire(key, 86400) end
      if count > 200 then
        ngx.status = 429
        ngx.header["Content-Type"] = "text/plain; charset=utf-8"
        ngx.say("Too Many Requests: daily limit reached")
        return ngx.exit(429)
      end
    }

    proxy_pass http://127.0.0.1:8090;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # ===============================
  # Next.js 动态页面代理
  # ===============================
  location ^~ /_next/ {
    proxy_pass http://127.0.0.1:3000;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    access_log off;
    expires 7d;
    add_header Cache-Control "public, max-age=31536000, immutable";
  }

  location = /favicon.ico {
    proxy_pass http://127.0.0.1:3000;
  }

  location / {
    proxy_pass http://127.0.0.1:3000;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_set_header Cookie $http_cookie;
    proxy_pass_header Set-Cookie;

    # WebSocket 支持 (Next.js HMR / API routes)
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # 可选：微缓存 SSR 页面（减少 Node 负载）
    # proxy_cache            ssr_cache;
    # proxy_cache_key        $scheme$host$request_uri;
    # proxy_cache_valid 200  10s;
    # proxy_cache_valid 404  1s;
    # add_header X-Cache $upstream_cache_status;
  }

  # ===============================
  # 隐藏文件保护
  # ===============================
  location ~ /\. {
    deny all;
  }

  # ===============================
  # 性能优化：gzip 压缩
  # ===============================
  gzip on;
  gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml;
  gzip_min_length 1024;
  gzip_proxied any;
  gzip_comp_level 6;
}
