name: Setup Proxy for global-homepage.svc.plus

on:
  workflow_dispatch:
  workflow_call:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 🚀 Configure Nginx on proxy host
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.GLOBAL_PROXY_HOST }}
          username: ${{ secrets.GLOBAL_PROXY_HOST_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            apt-get update
            apt-get install -y nginx
            cat <<'NGINXCONF' > /etc/nginx/sites-available/default
            # 1. HTTP 自动跳转到 HTTPS
            server {
              listen 80;
              server_name global-homepage.svc.plus;
              return 301 https://global-homepage.svc.plus$request_uri;
            }

            # 2. HTTPS 静态站部署
            server {
              listen 443 ssl http2;
              server_name global-homepage.svc.plus;

              ssl_certificate /etc/ssl/svc.plus.pem;
              ssl_certificate_key /etc/ssl/svc.plus.rsa.key;
              ssl_protocols TLSv1.2 TLSv1.3;
              ssl_ciphers HIGH:!aNULL:!MD5;

              root /var/www/XControl/ui/homepage/out;
              index index.html;

              location / {
                try_files $uri $uri/ /index.html;
              }
            }
            NGINXCONF
            systemctl restart nginx
