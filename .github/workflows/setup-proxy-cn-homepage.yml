name: Setup Proxy for cn-homepage.svc.plus

on:
  workflow_dispatch:
    inputs:
      dummy:
        description: 'Manual trigger'
        required: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ Configure Nginx on proxy host
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROXY_HOST }}
          username: ${{ secrets.PROXY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            apt-get update
            apt-get install -y nginx
            cat <<'NGINXCONF' > /etc/nginx/sites-available/default
            # 1. HTTP è‡ªåŠ¨è·³è½¬åˆ° HTTPS
            server {
              listen 80;
              server_name cn-homepage.svc.plus;
              return 301 https://cn-homepage.svc.plus$request_uri;
            }

            # 2. HTTPS é™æ€ç«™éƒ¨ç½² svc.plus
            server {
              listen 443 ssl http2;
              server_name cn-homepage.svc.plus;

              ssl_certificate /etc/ssl/svc.plus.pem;
              ssl_certificate_key /etc/ssl/svc.plus.rsa.key;
              ssl_protocols TLSv1.2 TLSv1.3;
              ssl_ciphers HIGH:!aNULL:!MD5;

              # 3. æŒ‡å‘é™æ€æ„å»ºè¾“å‡ºç›®å½•
              root /var/www/XControl/ui/homepage/out;
              index index.html;

              # 4. é¡µé¢è®¿é—®ï¼ˆå« SPA fallbackï¼‰
              location / {
                try_files $uri $uri/ /index.html;
              }

              # 5. é™æ€èµ„æºç¼“å­˜ä¼˜åŒ–
              location ~* \.(?:ico|css|js|gif|jpe?g|png|woff2?)$ {
                expires 30d;
                access_log off;
                add_header Cache-Control "public";
              }

              # 6. éšè— . æ–‡ä»¶ï¼ˆå¦‚ .DS_Storeï¼‰
              location ~ /\. {
                deny all;
              }
            }
            NGINXCONF
            systemctl restart nginx
